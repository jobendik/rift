<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIFT - Enhanced Footstep Indicator Test</title>
    <style>
        :root {
            --color-primary: #2c97de;
            --color-primary-dark: #1a75b8;
            --color-secondary: #ff5722;
            --color-text: #e0e0e0;
            --color-background: #121212;
            --color-panel: #1e1e1e;
            --color-panel-dark: #181818;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-error: #f44336;
            --color-muted: #757575;
            --color-enemy: #ff4136;
            --color-friendly: #2ecc40;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--color-panel-dark);
            padding: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-primary);
        }

        h1, h2, h3 {
            color: var(--color-primary);
            margin-top: 0;
        }

        header h1 {
            margin: 0;
            font-size: 24px;
        }

        .test-section {
            background-color: var(--color-panel);
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 8px 16px;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:hover {
            background-color: var(--color-primary-dark);
        }

        button:active {
            transform: translateY(1px);
        }

        button.stress-test {
            background-color: var(--color-error);
        }

        button.stress-test:hover {
            background-color: #d32f2f;
        }

        button.secondary {
            background-color: var(--color-secondary);
        }

        button.secondary:hover {
            background-color: #e64a19;
        }

        .select-group, .input-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        select, input {
            padding: 8px;
            background-color: var(--color-panel-dark);
            color: var(--color-text);
            border: 1px solid #444;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 14px;
        }

        label {
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--color-muted);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background-color: var(--color-panel-dark);
            border-radius: 4px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-muted);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }

        .visualization {
            position: relative;
            height: 400px;
            background-color: var(--color-panel-dark);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #444;
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            color: var(--color-muted);
            border: none;
            cursor: pointer;
            font-size: 14px;
            position: relative;
        }

        .tab-button.active {
            color: var(--color-primary);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .comparison-panel {
            background-color: var(--color-panel-dark);
            border-radius: 4px;
            padding: 15px;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .comparison-title {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
            color: var(--color-text);
        }

        .performance-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .performance-tag.enhanced {
            background-color: var(--color-success);
            color: #fff;
        }

        .performance-tag.legacy {
            background-color: var(--color-warning);
            color: #000;
        }

        .rift-footstep-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .rift-footstep-indicator__container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
        }

        .rift-footstep-indicator__indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px; /* Match indicatorWidth default */
            height: 320px;
            transform-origin: center 0;
            opacity: 0;
        }

        .rift-footstep-indicator__indicator--active {
            opacity: 0.7;
        }

        .rift-footstep-indicator__indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 120px;
            background: linear-gradient(to bottom, transparent, currentColor);
        }

        .rift-footstep-indicator__indicator--enemy {
            color: var(--color-enemy);
        }

        .rift-footstep-indicator__indicator--friendly {
            color: var(--color-friendly);
        }

        .rift-footstep-indicator__indicator--distant::before {
            opacity: 0.4;
            height: 80px;
        }

        .rift-footstep-indicator__indicator--medium::before {
            opacity: 0.7;
            height: 100px;
        }

        .rift-footstep-indicator__indicator--close::before {
            opacity: 1;
            height: 120px;
        }

        .rift-footstep-indicator__indicator--continuous::before {
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .player-character {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin-left: -10px;
            margin-top: -10px;
            background-color: var(--color-primary);
            border-radius: 50%;
            z-index: 10;
        }

        .player-direction {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            margin-left: -15px;
            margin-top: -15px;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid var(--color-primary);
            transform-origin: center center;
            transform: rotate(0deg);
            opacity: 0.6;
            z-index: 9;
        }

        .footstep-entity {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: -5px;
            margin-top: -5px;
            transition: all 0.5s ease-out;
            z-index: 8;
        }

        .footstep-entity.enemy {
            background-color: var(--color-enemy);
        }

        .footstep-entity.friendly {
            background-color: var(--color-friendly);
        }

        .footstep-distance {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            white-space: nowrap;
            color: var(--color-text);
            background-color: rgba(0,0,0,0.5);
            padding: 1px 4px;
            border-radius: 2px;
        }

        .log-panel {
            background-color: var(--color-panel-dark);
            border-radius: 4px;
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 12px;
            font-family: monospace;
        }

        .log-entry {
            margin-bottom: 4px;
            color: var(--color-muted);
        }

        .log-timestamp {
            color: var(--color-primary);
            margin-right: 5px;
        }

        .log-entry.info {
            color: var(--color-text);
        }

        .log-entry.warning {
            color: var(--color-warning);
        }

        .log-entry.error {
            color: var(--color-error);
        }

        .log-entry.success {
            color: var(--color-success);
        }

        .log-entry.event {
            color: #9c27b0;
        }

        /* Range slider custom styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }

        input[type="checkbox"] {
            margin: 0;
        }

        .checkbox-label {
            color: var(--color-text);
            font-size: 14px;
        }

        .debug-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.1;
            display: none;
        }

        .debug-grid.show {
            display: block;
        }

        .grid-line {
            position: absolute;
            background-color: white;
        }

        .grid-line.horizontal {
            width: 100%;
            height: 1px;
        }

        .grid-line.vertical {
            height: 100%;
            width: 1px;
        }

        .grid-center {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: rgba(255,255,255,0.3);
            top: 50%;
            left: 0;
        }

        .grid-center.vertical {
            width: 1px;
            height: 100%;
            top: 0;
            left: 50%;
        }

        .grid-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
        }

        .enhanced-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .mini-stat {
            background-color: #252525;
            padding: 8px;
            border-radius: 4px;
        }

        .mini-stat-label {
            font-size: 11px;
            color: var(--color-muted);
            margin-bottom: 2px;
        }

        .mini-stat-value {
            font-size: 14px;
            font-weight: bold;
        }

        .memory-timeline {
            height: 60px;
            width: 100%;
            background-color: #252525;
            position: relative;
            margin-top: 15px;
            border-radius: 4px;
            overflow: hidden;
        }

        .memory-graph-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 5px 0;
            box-sizing: border-box;
        }

        .memory-graph {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-end;
            gap: 1px;
        }

        .memory-bar {
            background-color: var(--color-primary);
            flex-grow: 1;
            min-width: 2px;
            height: 0;
            transition: height 0.3s;
        }

        .memory-bar.high {
            background-color: var(--color-warning);
        }

        .memory-bar.critical {
            background-color: var(--color-error);
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--color-muted);
            margin-top: 4px;
        }

        /* Animation for stress test counters */
        @keyframes counterHighlight {
            0% { color: var(--color-primary); }
            100% { color: var(--color-text); }
        }

        .highlight-change {
            animation: counterHighlight 1s;
        }
    </style>
</head>
<body>
    <header>
        <h1>Enhanced Footstep Indicator Test</h1>
    </header>

    <div class="container">
        <div class="test-section">
            <h2>Performance Comparison</h2>
            <p>Compare the performance of the original FootstepIndicator vs. the enhanced version with element pooling.</p>

            <div class="comparison-grid">
                <div class="comparison-panel">
                    <div class="comparison-header">
                        <h3 class="comparison-title">Enhanced Footstep Indicator</h3>
                        <span class="performance-tag enhanced">Optimized</span>
                    </div>
                    <div class="visualization" id="enhanced-visualization">
                        <div class="player-character"></div>
                        <div class="player-direction" id="enhanced-player-direction"></div>
                        <div class="debug-grid" id="enhanced-debug-grid"></div>
                        <div id="enhanced-footstep-container"></div>
                    </div>
                    <div class="stats-panel">
                        <div class="stat-box">
                            <div class="stat-label">Active Indicators</div>
                            <div class="stat-value" id="enhanced-active-count">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Created</div>
                            <div class="stat-value" id="enhanced-total-created">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Pool Utilization</div>
                            <div class="stat-value" id="enhanced-pool-utilization">0%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">DOM Operations</div>
                            <div class="stat-value" id="enhanced-dom-ops">0</div>
                        </div>
                    </div>
                    <div class="enhanced-stats-grid">
                        <div class="mini-stat">
                            <div class="mini-stat-label">Pool Size</div>
                            <div class="mini-stat-value" id="enhanced-pool-size">0</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-label">Available Elements</div>
                            <div class="mini-stat-value" id="enhanced-available">0</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-label">Block Count</div>
                            <div class="mini-stat-value" id="enhanced-block-count">0</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-label">Elements per Block</div>
                            <div class="mini-stat-value" id="enhanced-block-size">0</div>
                        </div>
                    </div>
                    <div class="memory-timeline">
                        <div class="memory-graph-container">
                            <div class="memory-graph" id="enhanced-memory-graph"></div>
                        </div>
                    </div>
                    <div class="timeline-labels">
                        <span>Past</span>
                        <span>DOM Operations Over Time</span>
                        <span>Now</span>
                    </div>
                </div>

                <div class="comparison-panel">
                    <div class="comparison-header">
                        <h3 class="comparison-title">Original Footstep Indicator</h3>
                        <span class="performance-tag legacy">Legacy</span>
                    </div>
                    <div class="visualization" id="legacy-visualization">
                        <div class="player-character"></div>
                        <div class="player-direction" id="legacy-player-direction"></div>
                        <div class="debug-grid" id="legacy-debug-grid"></div>
                        <div id="legacy-footstep-container"></div>
                    </div>
                    <div class="stats-panel">
                        <div class="stat-box">
                            <div class="stat-label">Active Indicators</div>
                            <div class="stat-value" id="legacy-active-count">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Created</div>
                            <div class="stat-value" id="legacy-total-created">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Element Reuse</div>
                            <div class="stat-value" id="legacy-reuse">0%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">DOM Operations</div>
                            <div class="stat-value" id="legacy-dom-ops">0</div>
                        </div>
                    </div>
                    <div class="memory-timeline">
                        <div class="memory-graph-container">
                            <div class="memory-graph" id="legacy-memory-graph"></div>
                        </div>
                    </div>
                    <div class="timeline-labels">
                        <span>Past</span>
                        <span>DOM Operations Over Time</span>
                        <span>Now</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>Test Controls</h2>
            
            <div class="test-controls">
                <div class="select-group">
                    <label for="indicator-type">Indicator Type</label>
                    <select id="indicator-type">
                        <option value="enemy">Enemy</option>
                        <option value="friendly">Friendly</option>
                    </select>
                </div>
                
                <div class="select-group">
                    <label for="distance-setting">Distance</label>
                    <select id="distance-setting">
                        <option value="close">Close</option>
                        <option value="medium" selected>Medium</option>
                        <option value="distant">Distant</option>
                        <option value="random">Random</option>
                    </select>
                </div>

                <div class="select-group">
                    <label for="sequence-count">Steps in Sequence</label>
                    <select id="sequence-count">
                        <option value="1">Single Step</option>
                        <option value="3" selected>3 Steps</option>
                        <option value="5">5 Steps</option>
                        <option value="8">8 Steps</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="angle-control">Direction Angle: <span id="angle-value">0</span>°</label>
                    <input type="range" id="angle-control" min="0" max="359" step="1" value="0">
                </div>
            </div>

            <div class="test-controls">
                <button id="single-step">Add Single Footstep</button>
                <button id="sequence-test">Add Footstep Sequence</button>
                <button id="clear-all">Clear All Indicators</button>
                <button id="random-test">Random Direction</button>
                <button id="toggle-rotation">Toggle Auto-Rotation</button>
            </div>

            <div class="test-controls">
                <button id="stress-5" class="stress-test">Stress Test (5/sec)</button>
                <button id="stress-10" class="stress-test">Stress Test (10/sec)</button>
                <button id="stress-20" class="stress-test">Stress Test (20/sec)</button>
                <button id="stress-50" class="stress-test">Stress Test (50/sec)</button>
                <button id="stop-stress" class="secondary">Stop Stress Test</button>
            </div>

            <div class="test-controls">
                <div class="checkbox-group">
                    <input type="checkbox" id="show-grid">
                    <label class="checkbox-label" for="show-grid">Show Debug Grid</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="show-entities" checked>
                    <label class="checkbox-label" for="show-entities">Show Entities</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="sync-both-views" checked>
                    <label class="checkbox-label" for="sync-both-views">Sync Both Views</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="reset-counters">
                    <label class="checkbox-label" for="reset-counters">Reset Counters on Clear</label>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>Event Log</h2>
            <div class="log-panel" id="log-panel"></div>
        </div>
    </div>

    <script type="module">
        import { ElementPool } from '../src/utils/ElementPool.js';
        import FootstepIndicator from '../src/components/ui/combat/FootstepIndicator.js';
        import EnhancedFootstepIndicator from '../src/components/ui/combat/EnhancedFootstepIndicator.js';

        // Mock the EventManager for testing purposes
        class MockEventManager {
            static emit() {}
            static on() {}
            static off() {}
            static setValidateEventNames() {}
            static setValidateEventPayloads() {}
        }

        // Mock the DOMFactory for testing purposes
        class MockDOMFactory {
            static createElement(type, className, options = {}) {
                const element = document.createElement(type);
                if (className) {
                    if (typeof className === 'string') {
                        element.className = className;
                    } else if (Array.isArray(className)) {
                        element.className = className.join(' ');
                    }
                }
                
                if (options.parent) {
                    options.parent.appendChild(element);
                }
                
                return element;
            }
        }

        // Mock a simplified UIComponent for testing
        class MockUIComponent {
            constructor() {
                this.isInitialized = false;
                this.isVisible = true;
                this.children = [];
            }
            
            init() {
                this.isInitialized = true;
                return this;
            }
            
            update() {
                return this;
            }
            
            dispose() {
                this.children.forEach(child => child.dispose());
                this.children = [];
                return this;
            }
            
            addChild(child) {
                this.children.push(child);
                return this;
            }
            
            registerEvents() {
                return this;
            }
            
            _createRootElement() {
                this.element = document.createElement('div');
                return this;
            }
            
            _updateAnimations() {
                return this;
            }
        }

        // DOM elements
        const enhancedContainer = document.getElementById('enhanced-footstep-container');
        const legacyContainer = document.getElementById('legacy-footstep-container');
        const logPanel = document.getElementById('log-panel');
        
        // Stats elements
        const enhancedActiveCount = document.getElementById('enhanced-active-count');
        const enhancedTotalCreated = document.getElementById('enhanced-total-created');
        const enhancedPoolUtilization = document.getElementById('enhanced-pool-utilization');
        const enhancedDomOps = document.getElementById('enhanced-dom-ops');
        const enhancedPoolSize = document.getElementById('enhanced-pool-size');
        const enhancedAvailable = document.getElementById('enhanced-available');
        const enhancedBlockCount = document.getElementById('enhanced-block-count');
        const enhancedBlockSize = document.getElementById('enhanced-block-size');
        
        const legacyActiveCount = document.getElementById('legacy-active-count');
        const legacyTotalCreated = document.getElementById('legacy-total-created');
        const legacyReuse = document.getElementById('legacy-reuse');
        const legacyDomOps = document.getElementById('legacy-dom-ops');
        
        // Controls
        const indicatorTypeSelect = document.getElementById('indicator-type');
        const distanceSettingSelect = document.getElementById('distance-setting');
        const sequenceCountSelect = document.getElementById('sequence-count');
        const angleControl = document.getElementById('angle-control');
        const angleValue = document.getElementById('angle-value');
        
        const singleStepButton = document.getElementById('single-step');
        const sequenceTestButton = document.getElementById('sequence-test');
        const clearAllButton = document.getElementById('clear-all');
        const randomTestButton = document.getElementById('random-test');
        const toggleRotationButton = document.getElementById('toggle-rotation');
        
        const stress5Button = document.getElementById('stress-5');
        const stress10Button = document.getElementById('stress-10');
        const stress20Button = document.getElementById('stress-20');
        const stress50Button = document.getElementById('stress-50');
        const stopStressButton = document.getElementById('stop-stress');
        
        const showGridCheckbox = document.getElementById('show-grid');
        const showEntitiesCheckbox = document.getElementById('show-entities');
        const syncBothViewsCheckbox = document.getElementById('sync-both-views');
        const resetCountersCheckbox = document.getElementById('reset-counters');
        
        const enhancedDebugGrid = document.getElementById('enhanced-debug-grid');
        const legacyDebugGrid = document.getElementById('legacy-debug-grid');
        const enhancedPlayerDirection = document.getElementById('enhanced-player-direction');
        const legacyPlayerDirection = document.getElementById('legacy-player-direction');
        
        // Initialize variables
        let enhancedIndicator = null;
        let legacyIndicator = null;
        let enhancedDomOperations = 0;
        let legacyDomOperations = 0;
        let currentRotation = 0;
        let isAutoRotating = false;
        let stressTestInterval = null;
        let memoryHistory = {
            enhanced: Array(50).fill(0),
            legacy: Array(50).fill(0)
        };
        
        // Create memory graph bars
        const enhancedMemoryGraph = document.getElementById('enhanced-memory-graph');
        const legacyMemoryGraph = document.getElementById('legacy-memory-graph');
        
        for (let i = 0; i < 50; i++) {
            const enhancedBar = document.createElement('div');
            enhancedBar.className = 'memory-bar';
            enhancedMemoryGraph.appendChild(enhancedBar);
            
            const legacyBar = document.createElement('div');
            legacyBar.className = 'memory-bar';
            legacyMemoryGraph.appendChild(legacyBar);
        }
        
        // Setup debug grid
        function setupDebugGrid(container) {
            // Add center lines
            const centerHorizontal = document.createElement('div');
            centerHorizontal.className = 'grid-center';
            container.appendChild(centerHorizontal);
            
            const centerVertical = document.createElement('div');
            centerVertical.className = 'grid-center vertical';
            container.appendChild(centerVertical);
            
            // Add circles for distance reference
            for (let radius of [50, 100, 150]) {
                const circle = document.createElement('div');
                circle.className = 'grid-circle';
                circle.style.width = (radius * 2) + 'px';
                circle.style.height = (radius * 2) + 'px';
                container.appendChild(circle);
            }
        }
        
        setupDebugGrid(enhancedDebugGrid);
        setupDebugGrid(legacyDebugGrid);
        
        // Initialize components with mocks
        function initializeComponents() {
            // Replace actual implementations with mocks
            window.DOMFactory = MockDOMFactory;
            window.EventManager = MockEventManager;
            FootstepIndicator.prototype._createRootElement = MockUIComponent.prototype._createRootElement;
            FootstepIndicator.prototype._updateAnimations = MockUIComponent.prototype._updateAnimations;
            EnhancedFootstepIndicator.prototype._createRootElement = MockUIComponent.prototype._createRootElement;
            EnhancedFootstepIndicator.prototype._updateAnimations = MockUIComponent.prototype._updateAnimations;
            
            // Create components
            enhancedIndicator = new EnhancedFootstepIndicator({
                container: enhancedContainer,
                maxIndicators: 8,
                baseDuration: 1000,
                minOpacity: 0.2,
                maxOpacity: 0.7,
                maxDistance: 20,
                minDistance: 2,
                indicatorWidth: 40
            });
            
            legacyIndicator = new FootstepIndicator({
                container: legacyContainer,
                maxIndicators: 8,
                baseDuration: 1000,
                minOpacity: 0.2,
                maxOpacity: 0.7,
                maxDistance: 20,
                minDistance: 2,
                indicatorWidth: 40
            });
            
            // Initialize
            enhancedIndicator.init();
            legacyIndicator.init();
            
            // Monkey patch to track DOM operations
            const originalEnhancedAcquire = enhancedIndicator.indicatorPool.acquire;
            enhancedIndicator.indicatorPool.acquire = function() {
                enhancedDomOperations++;
                return originalEnhancedAcquire.apply(this, arguments);
            };
            
            const originalGetIndicator = legacyIndicator._getIndicator;
            legacyIndicator._getIndicator = function() {
                legacyDomOperations++;
                return originalGetIndicator.apply(this, arguments);
            };
            
            // Update stats initially
            updateStats();
            
            // Start animation loop
            requestAnimationFrame(animationLoop);
            
            addLogEntry("Components initialized", "success");
        }
        
        // Animation loop
        function animationLoop(timestamp) {
            // Update components
            if (enhancedIndicator) enhancedIndicator.update(16.67); // ~60fps
            if (legacyIndicator) legacyIndicator.update(16.67);
            
            // Auto rotation if enabled
            if (isAutoRotating) {
                currentRotation = (currentRotation + 0.5) % 360;
                updateRotation();
            }
            
            // Update stats
            updateStats();
            
            // Continue loop
            requestAnimationFrame(animationLoop);
        }
        
        // Update all stats displays
        function updateStats() {
            if (!enhancedIndicator || !legacyIndicator) return;
            
            // Get enhanced stats
            const enhancedStats = enhancedIndicator.getPerformanceStats();
            const enhancedActive = enhancedStats.activeIndicators;
            const poolStats = enhancedStats.poolStats || {};
            
            // Update enhanced counters
            enhancedActiveCount.textContent = enhancedActive;
            enhancedTotalCreated.textContent = poolStats.totalCreated || 0;
            enhancedPoolUtilization.textContent = poolStats.utilizationPercentage || 0;
            enhancedDomOps.textContent = enhancedDomOperations;
            
            // Update enhanced pool stats
            enhancedPoolSize.textContent = poolStats.poolSize || 0;
            enhancedAvailable.textContent = poolStats.availableCount || 0;
            enhancedBlockCount.textContent = poolStats.blockCount || 0;
            enhancedBlockSize.textContent = poolStats.blockSize || 0;
            
            // Get legacy stats
            const legacyActive = legacyIndicator.activeIndicators.length;
            const legacyTotal = legacyIndicator.indicatorPool.length;
            const legacyReused = legacyTotal > 0 ? Math.round((legacyTotal - legacyActive) / legacyTotal * 100) : 0;
            
            // Update legacy counters
            legacyActiveCount.textContent = legacyActive;
            legacyTotalCreated.textContent = legacyTotal;
            legacyReuse.textContent = legacyReused + '%';
            legacyDomOps.textContent = legacyDomOperations;
            
            // Update memory graphs
            updateMemoryGraph();
        }
        
        // Add entity visualization for footstep source
        function addEntityVisualization(container, angle, distance, isFriendly, type) {
            if (!showEntitiesCheckbox.checked) return;
            
            const visualization = container.closest('.visualization');
            const centerX = visualization.offsetWidth / 2;
            const centerY = visualization.offsetHeight / 2;
            
            // Convert angle and distance to coordinates
            const radians = (angle * Math.PI) / 180;
            const xOffset = Math.sin(radians) * distance * 10; // Scale by 10 for visualization
            const yOffset = -Math.cos(radians) * distance * 10;
            
            const entity = document.createElement('div');
            entity.className = `footstep-entity ${isFriendly ? 'friendly' : 'enemy'}`;
            entity.style.left = (centerX + xOffset) + 'px';
            entity.style.top = (centerY + yOffset) + 'px';
            
            // Add distance label
            const distanceLabel = document.createElement('div');
            distanceLabel.className = 'footstep-distance';
            distanceLabel.textContent = `${distance.toFixed(1)}m ${type || ''}`;
            entity.appendChild(distanceLabel);
            
            visualization.appendChild(entity);
            
            // Remove after animation
            setTimeout(() => {
                if (entity.parentNode) {
                    entity.parentNode.removeChild(entity);
                }
            }, 5000);
        }
        
        // Add a footstep with current settings
        function addFootstep(isSequence = false) {
            if (!enhancedIndicator || !legacyIndicator) return;
            
            const angle = parseInt(angleControl.value);
            const isEnemy = indicatorTypeSelect.value === 'enemy';
            const isFriendly = !isEnemy;
            const distanceSetting = distanceSettingSelect.value;
            const sequenceCount = parseInt(sequenceCountSelect.value);
            
            // Map distance setting to actual distance value
            let distance;
            switch (distanceSetting) {
                case 'close':
                    distance = 2 + Math.random() * 2; // 2-4 units
                    break;
                case 'medium':
                    distance = 5 + Math.random() * 5; // 5-10 units
                    break;
                case 'distant':
                    distance = 11 + Math.random() * 9; // 11-20 units
                    break;
                case 'random':
                    distance = 2 + Math.random() * 18; // 2-20 units
                    break;
                default:
                    distance = 10;
            }
            
            // Enhanced indicator
            if (isSequence) {
                enhancedIndicator.showFootstepSequence({
                    angle,
                    distance,
                    isFriendly,
                    steps: sequenceCount,
                    interval: 200
                });
                
                addEntityVisualization(enhancedContainer, angle, distance, isFriendly, 'sequence');
            } else {
                enhancedIndicator.showFootstepsFrom({
                    angle,
                    distance,
                    isFriendly
                });
                
                addEntityVisualization(enhancedContainer, angle, distance, isFriendly);
            }
            
            // Legacy indicator if synced
            if (syncBothViewsCheckbox.checked) {
                if (isSequence) {
                    for (let i = 0; i < sequenceCount; i++) {
                        setTimeout(() => {
                            const isContinuous = i < sequenceCount - 1;
                            legacyIndicator.showFootstepsFrom({
                                angle,
                                distance,
                                isFriendly,
                                isContinuous
                            });
                            
                            if (i === 0) {
                                addEntityVisualization(legacyContainer, angle, distance, isFriendly, 'sequence');
                            }
                        }, i * 200);
                    }
                } else {
                    legacyIndicator.showFootstepsFrom({
                        angle,
                        distance,
                        isFriendly
                    });
                    
                    addEntityVisualization(legacyContainer, angle, distance, isFriendly);
                }
            }
            
            // Log the action
            const logMessage = `${isEnemy ? 'Enemy' : 'Friendly'} footstep ${isSequence ? 'sequence' : ''} at ${angle}° (${distanceSetting}, ${distance.toFixed(1)}m)`;
            addLogEntry(logMessage, 'info');
            
            // Update memory graph
            updateMemoryGraph(true);
        }
        
        // Update memory graph
        function updateMemoryGraph(addBar = false) {
            // Shift memory history
            if (addBar) {
                memoryHistory.enhanced.shift();
                memoryHistory.enhanced.push(enhancedDomOperations);
                
                memoryHistory.legacy.shift();
                memoryHistory.legacy.push(legacyDomOperations);
            }
            
            // Find max value for scaling
            const maxEnhanced = Math.max(...memoryHistory.enhanced);
            const maxLegacy = Math.max(...memoryHistory.legacy);
            const maxValue = Math.max(maxEnhanced, maxLegacy, 1);
            
            // Update bars
            const enhancedBars = enhancedMemoryGraph.querySelectorAll('.memory-bar');
            const legacyBars = legacyMemoryGraph.querySelectorAll('.memory-bar');
            
            enhancedBars.forEach((bar, i) => {
                const value = memoryHistory.enhanced[i];
                const height = (value / maxValue) * 100;
                bar.style.height = `${height}%`;
                
                // Color based on value
                bar.className = 'memory-bar';
                if (height > 70) bar.classList.add('critical');
                else if (height > 40) bar.classList.add('high');
            });
            
            legacyBars.forEach((bar, i) => {
                const value = memoryHistory.legacy[i];
                const height = (value / maxValue) * 100;
                bar.style.height = `${height}%`;
                
                // Color based on value
                bar.className = 'memory-bar';
                if (height > 70) bar.classList.add('critical');
                else if (height > 40) bar.classList.add('high');
            });
        }
        
        // Update rotation display
        function updateRotation() {
            angleValue.textContent = Math.round(currentRotation);
            angleControl.value = Math.round(currentRotation);
            
            enhancedPlayerDirection.style.transform = `rotate(${currentRotation}deg)`;
            legacyPlayerDirection.style.transform = `rotate(${currentRotation}deg)`;
        }
        
        // Add log entry
        function addLogEntry(message, type = '') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'log-timestamp';
            const now = new Date();
            timestamp.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            entry.appendChild(timestamp);
            entry.appendChild(document.createTextNode(message));
            
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Limit log size
            while (logPanel.children.length > 100) {
                logPanel.removeChild(logPanel.firstChild);
            }
        }
        
        // Run stress test
        function runStressTest(frequency) {
            // Stop any existing test
            stopStressTest();
            
            // Start new test
            const interval = 1000 / frequency;
            addLogEntry(`Starting stress test (${frequency}/sec)`, 'warning');
            
            stressTestInterval = setInterval(() => {
                // Random angle
                angleControl.value = Math.floor(Math.random() * 360);
                currentRotation = parseInt(angleControl.value);
                updateRotation();
                
                // Add footstep
                addFootstep(Math.random() > 0.7); // 30% chance of sequence
            }, interval);
        }
        
        // Stop stress test
        function stopStressTest() {
            if (stressTestInterval) {
                clearInterval(stressTestInterval);
                stressTestInterval = null;
                addLogEntry('Stopped stress test', 'info');
            }
        }
        
        // Event listeners
        singleStepButton.addEventListener('click', () => addFootstep(false));
        sequenceTestButton.addEventListener('click', () => addFootstep(true));
        
        clearAllButton.addEventListener('click', () => {
            enhancedIndicator.clearAllIndicators();
            legacyIndicator.clearAllIndicators();
            
            // Reset counters if checkbox is checked
            if (resetCountersCheckbox.checked) {
                enhancedDomOperations = 0;
                legacyDomOperations = 0;
                
                // Reset memory history
                memoryHistory.enhanced = Array(50).fill(0);
                memoryHistory.legacy = Array(50).fill(0);
                updateMemoryGraph();
            }
            
            addLogEntry('Cleared all indicators', 'info');
        });
        
        randomTestButton.addEventListener('click', () => {
            angleControl.value = Math.floor(Math.random() * 360);
            currentRotation = parseInt(angleControl.value);
            updateRotation();
            addFootstep(Math.random() > 0.5);
        });
        
        toggleRotationButton.addEventListener('click', () => {
            isAutoRotating = !isAutoRotating;
            toggleRotationButton.textContent = isAutoRotating ? 'Stop Auto-Rotation' : 'Toggle Auto-Rotation';
            addLogEntry(isAutoRotating ? 'Started auto-rotation' : 'Stopped auto-rotation', 'info');
        });
        
        angleControl.addEventListener('input', () => {
            currentRotation = parseInt(angleControl.value);
            updateRotation();
        });
        
        stress5Button.addEventListener('click', () => runStressTest(5));
        stress10Button.addEventListener('click', () => runStressTest(10));
        stress20Button.addEventListener('click', () => runStressTest(20));
        stress50Button.addEventListener('click', () => runStressTest(50));
        stopStressButton.addEventListener('click', stopStressTest);
        
        showGridCheckbox.addEventListener('change', () => {
            enhancedDebugGrid.classList.toggle('show', showGridCheckbox.checked);
            legacyDebugGrid.classList.toggle('show', showGridCheckbox.checked);
        });
        
        // Initialize the components
        initializeComponents();
        
        // Initial log
        addLogEntry('Test page loaded', 'success');
        addLogEntry('Compare the performance of original vs. enhanced implementations', 'info');
    </script>
